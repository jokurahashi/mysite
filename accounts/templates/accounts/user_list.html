{% block content %}
  <h2>ユーザー一覧</h2>

  <!-- メッセージを表示 -->
  {% if messages %}
    <ul>
      {% for message in messages %}
        <script>
          alert("{{ message }}");
        </script>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- 検索フォーム -->
  <form id="searchForm" method="get" style="margin-bottom: 10px;">
<div style="display: flex; gap: 15px; margin-bottom: 10px;">
    <div>
      <label for="username">ユーザー名:</label><br>
      <input type="text" id="username" name="username" value="{{ username_query }}">
    </div>

    <div>
      <label for="email">メールアドレス:</label><br>
      <input type="text" id="email" name="email" value="{{ email_query }}">
    </div>
  </div>

  <!-- 作成日時 -->
  <div style="margin-bottom: 10px;">
    <label>作成日時:</label><br>
    <input type="date" name="created_from" value="{{ created_from }}"> ～ 
    <input type="date" name="created_to" value="{{ created_to }}">
  </div>

  <!-- 更新日時 -->
  <div style="margin-bottom: 15px;">
    <label>更新日時:</label><br>
    <input type="date" name="updated_from" value="{{ updated_from }}"> ～ 
    <input type="date" name="updated_to" value="{{ updated_to }}">
  </div>

  <!-- 検索ボタン -->
  <div>
    <button type="submit" style="padding: 10px 20px; font-size: 1.2em;">検索</button>
  </div>
</form>

  <!-- 検索履歴 -->
  <div id="searchHistory" style="margin-bottom: 15px;">
    <strong>検索履歴:</strong>
    <ul id="historyList" style="list-style:none; padding-left:0;"></ul>
  </div>

  <!-- 一覧 -->
  <table border="1" cellpadding="5">
    <tr>
      <th>No</th>
      <th>ユーザー名</th>
      <th>メールアドレス</th>
      <th>誕生日</th>
      <th>作成日時</th>
      <th>更新日時</th>
    </tr>
    {% for user in users %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td><a href="{% url 'accounts:user_detail' user.pk %}">{{ user.username }}</a></td>
        <td>{{ user.email }}</td>
        <td>{{ user.birthday|date:"Y-m-d" }}</td>
        <td>{{ user.created_at|date:"Y-m-d H:i" }}</td>
        <td>{{ user.updated_at|date:"Y-m-d H:i" }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="6">登録されたユーザーはいません。</td></tr>
    {% endfor %}
  </table>

<div style="display: flex; gap: 15px; margin-top: 15px; align-items: center;">
    <a href="{% url 'accounts:signup' %}" style="line-height: 1.5;">新規ユーザー登録</a>

    <a href="{% url 'accounts:export_users_csv' %}?username={{ request.GET.username }}&email={{ request.GET.email }}&created_from={{ request.GET.created_from }}&created_to={{ request.GET.created_to }}&updated_from={{ request.GET.updated_from }}&updated_to={{ request.GET.updated_to }}">CSVダウンロード</a>




    <a href="#" style="line-height: 1.5;" onclick="document.getElementById('csv_upload').click(); return false;">CSVアップロード</a>

    <form id="csv_form" action="{% url 'accounts:import_users_csv' %}" method="post" enctype="multipart/form-data" style="display: none;">
        {% csrf_token %}
        <input type="file" name="csv_file" id="csv_upload" accept=".csv" onchange="document.getElementById('csv_form').submit();">
    </form>
</div>

<!-- 検索履歴 -->
  <script>
  const HISTORY_KEY = "userSearchHistory";

  // 履歴を取得
  function getHistory() {
    const history = localStorage.getItem(HISTORY_KEY);
    return history ? JSON.parse(history) : [];
  }

  // 履歴を保存
  function saveHistory(username, email) {
    if (!username && !email) return;

    const history = getHistory();
    const newdata = { username, email };

    // 重複削除
    const filtered = history.filter(
      item => item.username !== username || item.email !== email
    );

    // 最新を先頭に追加
    filtered.unshift(newdata);

    // 最大5件まで保存
    localStorage.setItem(HISTORY_KEY, JSON.stringify(filtered.slice(0, 5)));
  }

  // 履歴を表示
  function displayHistory() {
    const historyList = document.getElementById("historyList");
    const history = getHistory();
    historyList.innerHTML = "";

    history.forEach(item => {
      const li = document.createElement("li");
      li.style.padding = "3px 0";
      const span = document.createElement("span");
      span.textContent = `${item.username || "User Not"} / ${item.email || "Email Not"}`;
      span.style.cursor = "pointer"; // 文字部分だけクリック可能
      span.addEventListener("click", () => {
        document.getElementById("usernameInput").value = item.username;
        document.getElementById("emailInput").value = item.email;
        document.getElementById("searchForm").submit();
      });

      li.appendChild(span);
      historyList.appendChild(li);
    });
  }

  // 検索時に履歴保存
  document.getElementById("searchForm").addEventListener("submit", () => {
    const username = document.getElementById("usernameInput").value.trim();
    const email = document.getElementById("emailInput").value.trim();
    saveHistory(username, email);
  });

  // ページ読み込み時に履歴を表示
  displayHistory();
</script>
{% endblock %}
