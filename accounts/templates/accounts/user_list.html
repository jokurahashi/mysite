{% block content %}
  <h2>ユーザー一覧</h2>

  <!-- メッセージを表示 -->
  {% if messages %}
    <ul>
      {% for message in messages %}
        <script>
          alert("{{ message }}");
        </script>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- 検索フォーム -->
  <form id="searchForm" method="get" style="margin-bottom: 10px;">
    <input type="text" id="usernameInput" name="username" placeholder="ユーザー名" value="{{ username_query }}">
    <input type="text" id="emailInput" name="email" placeholder="メールアドレス" value="{{ email_query }}">
    <button type="submit">検索</button>
  </form>

  <!-- 検索履歴 -->
  <div id="searchHistory" style="margin-bottom: 15px;">
    <strong>検索履歴:</strong>
    <ul id="historyList" style="list-style:none; padding-left:0;"></ul>
  </div>

  <!-- 一覧 -->
  <table border="1" cellpadding="5">
    <tr>
      <th>No</th>
      <th>ユーザー名</th>
      <th>メールアドレス</th>
      <th>誕生日</th>
      <th>作成日時</th>
      <th>更新日時</th>
    </tr>
    {% for user in users %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td><a href="{% url 'accounts:user_detail' user.pk %}">{{ user.username }}</a></td>
        <td>{{ user.email }}</td>
        <td>{{ user.birthday|date:"Y-m-d" }}</td>
        <td>{{ user.created_at|date:"Y-m-d H:i" }}</td>
        <td>{{ user.updated_at|date:"Y-m-d H:i" }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="6">登録されたユーザーはいません。</td></tr>
    {% endfor %}
  </table>

  <p><a href="{% url 'accounts:signup' %}">新規ユーザー登録</a></p>
  
<!-- 検索履歴 -->
  <script>
  const HISTORY_KEY = "userSearchHistory";

  // 履歴を取得
  function getHistory() {
    const history = localStorage.getItem(HISTORY_KEY);
    return history ? JSON.parse(history) : [];
  }

  // 履歴を保存
  function saveHistory(username, email) {
    if (!username && !email) return;

    const history = getHistory();
    const newdata = { username, email };

    // 重複削除
    const filtered = history.filter(
      item => item.username !== username || item.email !== email
    );

    // 最新を先頭に追加
    filtered.unshift(newdata);

    // 最大5件まで保存
    localStorage.setItem(HISTORY_KEY, JSON.stringify(filtered.slice(0, 5)));
  }

  // 履歴を表示
  function displayHistory() {
    const historyList = document.getElementById("historyList");
    const history = getHistory();
    historyList.innerHTML = "";

    history.forEach(item => {
      const li = document.createElement("li");
      li.style.padding = "3px 0";
      const span = document.createElement("span");
      span.textContent = `${item.username || "User Not"} / ${item.email || "Email Not"}`;
      span.style.cursor = "pointer"; // 文字部分だけクリック可能
      span.addEventListener("click", () => {
        document.getElementById("usernameInput").value = item.username;
        document.getElementById("emailInput").value = item.email;
        document.getElementById("searchForm").submit();
      });

      li.appendChild(span);
      historyList.appendChild(li);
    });
  }

  // 検索時に履歴保存
  document.getElementById("searchForm").addEventListener("submit", () => {
    const username = document.getElementById("usernameInput").value.trim();
    const email = document.getElementById("emailInput").value.trim();
    saveHistory(username, email);
  });

  // ページ読み込み時に履歴を表示
  displayHistory();
</script>
{% endblock %}
